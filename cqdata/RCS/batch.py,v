head	1.4;
access;
symbols;
locks
	administrator:1.4
                                                                                                                                                                                                        ; strict;
comment	@# @;


1.4
date	2012.02.06.07.50.19;	author administrator;	state Exp;
branches;
next	1.3;

1.3
date	2011.12.09.09.13.01;	author administrator;	state Exp;
branches;
next	1.2;

1.2
date	2011.12.06.08.00.39;	author administrator;	state Exp;
branches;
next	1.1;

1.1
date	2011.11.25.01.44.25;	author administrator;	state Exp;
branches;
next	1.0;

1.0
date	2011.11.18.10.10.38;	author administrator;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Ôö¼ÓÁËÊÖ»úÄ³ÔÂ´®ºÅĞÅÏ¢²éÑ¯,¿ÉÒÔ²é´®ºÅ,»úĞÍ,²Ù×÷ÏµÍ³(ÊÇ·ñÖÇÄÜ»ú)
@
text
@ï»¿# -*- coding: utf-8 -*-
# $Header: D:\\RCS\\D\\python_study\\cherrypy\\forum\\__init__.py,v 1.0 2011-10-08 22:54:04+08 administrator Exp administrator $
import sqlite3, os, chardet, MySQL, cherrypy, cgi, sys, xlrd, time, datetime, traceback, my_tools, config, dbapi
from HTMLTags import TR, TD, INPUT, SELECT, OPTION
name = 'æ‰¹é‡å³å¸­æŸ¥è¯¢'
__all__ = ['batch1', 'batch21', 'batch22', 'batch3', 'batch4', 'batch4_base', 'batch5', 'batch5_con', 'batch4_c', 'batch6', 'batch7', 'batch8', 'batch_cust', 'batch_uim', 'batch_byte', 'batch_esn', 'batch_esn_xxx']

def header(forum_url=".",url='',**kw):
	'''è®ºå›é¡µçœ‰,å…¬ç”¨å…ˆè°ƒç”¨çš„å‡½æ•°, å¯ä»¥åªåœ¨æ­¤å¤„æ£€æŸ¥æ˜¯å¦ç™»å½•,è€Œä¸ç”¨å¯¹æ¯ä¸€ä¸ªéœ€è¦å‘å¸ƒçš„å‡½æ•°éƒ½æ£€æŸ¥ç™»å½•æƒ…å†µ'''

	if 'fengongshi' in kw or cherrypy.session.get('fengongshi','')=='':
		cherrypy.session['fengongshi'] = str(kw.get('fengongshi','33')) or '33'
		raise cherrypy.HTTPRedirect(cherrypy.url().decode('utf-8'))
	init_days = 2	# æ­¤å¤„è®¾ç½®æ¬¡æœˆå‡ æ—¥æ‰å‡ºå¸
	fee_month = int((datetime.datetime.now()+datetime.timedelta(days=-init_days)).strftime('%Y%m'))-1
	fee_month = fee_month % 100 and str(fee_month) or str(fee_month-88)
	if 'feemonth' in kw or cherrypy.session.get('feemonth','')=='':
		cherrypy.session['feemonth'] = str(kw.get('feemonth',fee_month)) or fee_month
		raise cherrypy.HTTPRedirect(cherrypy.url().decode('utf-8'))
	yield '<html><head><title>æ•°æ®é›†å¸‚</title><script language="JavaScript" src="/static_files/calendar.js"></script><link rel="Stylesheet" href="/static_files/k_base.css"></link></head><body>\n'
	yield '<form style="display:inline" name="form0" ><select name=fengongshi onchange="document.form0.submit()">'
	s_name, s_id = config.dict_name.values(), config.dict_name.keys()
	yield '%s' % OPTION(s_name, value=s_id, selected=cherrypy.session.setdefault('fengongshi',''))
	yield '</select></form>'
	yield '<form style="display:inline" name="form1" ><select name=feemonth onchange="document.form1.submit()">'
	months = ['201107', '201108','201109','201110','201111','201112']
	months += map(lambda x:'2012'+('0'+str(x))[-2:], range(1,13))
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('%Y%m')
	if ymd in months:
		index = months.index(ymd)
		months = months[:index+1]
	s_name, s_id = months,months
	yield '%s' % OPTION(s_name, value=s_id, selected=cherrypy.session.setdefault('feemonth',fee_month))
	yield '</select></form>'
	yield '<a href="..">ä¸Šçº§</a> | <a href="%s">è¿”å›é¦–é¡µ</a>' % forum_url
	for col in globals()['__all__']:
		#yield ' | <a href="%s">%s</a>' % (col, getattr(globals()[col],'__doc__',col))
		yield url<>col and ' | <a href="%s">%s</a>' % (col, getattr(globals()[col], '__doc__', col)) or ' | %s' % getattr(globals()[col], '__doc__', col)
		#yield url==col and ' | %s' % __all_name[__all__.index(col)] or ' | <a href="%s/%s">%s</a>' % (forum_url, col, __all_name[__all__.index(col)]
	yield '<hr />'

def footer():
	'''è®ºå›é¡µè„š'''

	yield '\n</body></html>'

def index(**kw):
	'''è®ºå›é¦–é¡µ'''

	yield ''.join(header(**kw))
	yield '''æœ¬é¡µæ˜¯æ ¹æ®æ—¥å¸¸åº”ç”¨ä¸­çš„ä¸€äº›éœ€æ±‚,å°†æ‰¹é‡æŸ¥è¯¢æŠ½è±¡ä¸ºä¸€ä¸ªç•Œé¢,å¯ä»¥ä¸€æ¬¡æŸ¥å¤šä¸ªå·ç çš„ç›¸å…³ä¿¡æ¯,ç›¸å½“äºè¥ç»´ç³»ç»Ÿå¯¼å…¥æŸ¥è¯¢çš„æ”¹è¿›.
	1.å·ç ç½‘æ ¼ç­‰åŸºæœ¬èµ„æ–™æŸ¥è¯¢
	'''.replace('\n', '<br />\n')
	yield '%s' % globals().keys()
	yield '%s' % sys.modules[__name__]
	yield 'name: %s ' % __name__
	yield ''.join(footer())
index.exposed = True

def add_pro(num):
	'''å¤„ç†å·ç è¯·æ±‚,1:åœ¨å›ºå®šç”µè¯å‰é¢è‡ªåŠ¨åŠ '023-', 2:åœ¨å®½å¸¦å‰é¢è‡ªåŠ¨åŠ "023-0" '''
	num = num.strip()
	if num.startswith('23'): num = '023-0' + num
	if num[:2] not in ('13','15','18') and not num.startswith('023-'):
		num = '023-' + num
	return num

def batch1(*k, **kw):
	'''æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬èµ„æ–™'''

	t1 = time.time()
	yield ''.join(header(url='batch1', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select %s from %s a left join DIM_ZONE_area b on a.mkt_grid_id=b.mkt_grid_id left join dim_zone_comm c on a.com_grid_id=c.com_grid_id left join %s d on a.mkt_cust_code=d.mkt_cust_code left join dim_crm_product product on a.product_id=product.product_id

	left join %s cust on a.cust_id=cust.cust_id where acc_nbr in (%s) 
	and serv_num=1
	;''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	fee_month = '_'+cherrypy.session.get('feemonth',ymd[1:7])
	# å¦‚æœä¸æ˜¯é€‰å–çš„å½“å‰æœˆä»½,åˆ™é‡‡ç”¨æœˆè¡¨,å¦åˆ™é‡‡å–æœ€è¿‘çš„æ—¥è¡¨æ•°æ®
	#print '--', fee_month, ymd[:7]
	if fee_month == ymd[:7]:
		tbl_name += ymd
		tbl_cust += ymd
		tbl_cust_code += ymd
	else:
		tbl_name += fee_month
		tbl_cust += fee_month
		tbl_cust_code += fee_month
	sql = sql % ('%s', tbl_name, tbl_cust, tbl_cust_code, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % (kw_n['dis_cols'], ','.join(acc_nbr))
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = ['acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'fxh_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "user_grp_type", "contact_tel", "deputy_acc_nbr", "a.state", 'a.serv_state', 'a.serv_num', 'a.completed_date', 'billing_mode_id', 'cust.cust_name', 'cust.cust_address']
	cols_name = 'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  åˆ†çº¿ç›’ æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  ç”¨æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç  ç”¨æˆ·çŠ¶æ€ è®¾å¤‡çŠ¶æ€ åˆ°è¾¾æ ‡å¿— ç«£å·¥æ—¶é—´ è®¡è´¹æ¨¡å¼ äº§æƒå®¢æˆ·å§“å äº§æƒå®¢æˆ·åœ°å€'.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥é€‰å–çš„æœˆä»½ä¸æ˜¯å½“å‰æœˆ,åˆ™ç”¨è¯¥æœˆçš„æœˆè¡¨.è‹¥æ˜¯å½“å‰æœˆ,åˆ™é‡‡å–æœ€æ–°çš„æ—¥è¡¨.
	6.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch1.exposed = True

def batch21(*k, **kw):
	'''ADSLå…±çº¿ç¾¤æŸ¥è¯¢'''

	return ''.join(batch2(rule1=1, rule2=2, rule3=90, group_type_id=1000, url='batch21', *k, **kw))
batch21.exposed = True

def batch22(*k, **kw):
	'''IPTV(ADSL)ç¾¤'''

	return ''.join(batch2(rule1=1, rule2=1518, rule3=1519, group_type_id=2003, url='batch22', *k, **kw))
batch22.exposed = True

def batch2(*k, **kw):
	'''ADSLå…±çº¿ç¾¤æŸ¥è¯¢'''

	t1 = time.time()
	yield ''.join(header(**kw))
	kw_n = my_tools.query_dict(**kw)
	sql = ''' select %(dis_cols)s, a.group_id, gh_a.acc_nbr, adsl_a.acc_nbr, itv_a.acc_nbr from 
	(select a.acc_nbr,a.user_name, a.prod_addr, a.jjx_code, a.sub_exch_id, a.down_velocity, a.mkt_cust_code, cust_grp_type, contact_tel, deputy_acc_nbr, b.group_id, a.serv_id, com_grid_name, com_channel_name, mkt_grid_name, mkt_channel_name, rule_type, product_name
	from ds_chn_prd_serv_AREA_FEEMONTH a 
	left join dm_prd_crm_service_grp_member b on a.serv_id=b.serv_id 
	and b.member_role_id in (%(rule1)s, %(rule2)s, %(rule3)s) 
	left join DM_PRD_SERVICE_GROUP c on b.group_id=c.group_id
	left join dim_zone_area mkt on a.mkt_grid_id=mkt.mkt_grid_id
	left join dim_zone_comm com on a.com_grid_id=com.com_grid_id
	left join ds_chn_prd_cust_AREA_FEEMONTH cust on a.mkt_cust_code=cust.mkt_cust_code
	left join dim_crm_product product on a.product_id=product.product_id
	where a.acc_nbr in (%(acc_nbr_sql)s)
	and c.group_type_id=%(group_type_id)s)  a
	left join dm_prd_crm_service_grp_member gh on a.group_id=gh.group_id and gh.member_role_id=%(rule1)s
	left join ds_chn_prd_serv_AREA_FEEMONTH gh_a on gh.serv_id=gh_a.serv_id
	left join dm_prd_crm_service_grp_member adsl on a.group_id=adsl.group_id and adsl.member_role_id=%(rule2)s
	left join ds_chn_prd_serv_AREA_FEEMONTH adsl_a on adsl.serv_id=adsl_a.serv_id
	left join dm_prd_crm_service_grp_member itv on a.group_id=itv.group_id and itv.member_role_id=%(rule3)s
	left join ds_chn_prd_serv_AREA_FEEMONTH itv_a on itv.serv_id=itv_a.serv_id ;'''
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	kw_n['acc_nbr_sql'] = ','.join(acc_nbr)
	sql = sql.replace('AREA', cherrypy.session.get('fengongshi','33'))
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('%Y%m%d')
	sql = sql.replace('FEEMONTH', ymd)
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql.replace('\n', '<br />')
	if 'a.rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when a.rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('a.rule_type')] = "case %s end" % str_tmp 
	if len(acc_nbr):
		if kw_n['dis_cols']=='':
			kw_n['dis_cols'] = []
		if type(kw_n['dis_cols'])<>type([]):
			kw_n['dis_cols'] = [kw_n['dis_cols']]
		kw_n['dis_cols'] = ','.join(['a.acc_nbr']+kw_n['dis_cols'])
		sql = sql % kw_n
		recs = dbapi.Table( _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or '\t',dis_serial))).decode('utf-8')
	yield '''<tr><td width="20%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = ['a.acc_nbr', 'a.user_name', 'a.prod_addr', 'a.mkt_channel_name', 'a.mkt_grid_name', 'a.com_channel_name', 'a.com_grid_name', 'a.rule_type', 'a.jjx_code', 'a.sub_exch_id', 'a.product_name', 'a.down_velocity', 'a.mkt_cust_code', "a.cust_grp_type", "a.contact_tel", "a.deputy_acc_nbr"]
	cols_name = 'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	#yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s</td>' % INPUT(type="submit", value="æå–")
	yield '''<td with="60%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' 
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())

def batch3(*k, **kw):
	'''æ ¹æ®åˆåŒå·æç”µè¯å·ç '''

	t1 = time.time()
	yield ''.join(header(url='batch3', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select acc_nbr from %s a where mkt_cust_code in (%s);''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name += ymd
	sql = sql % (tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		#dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		#kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯åˆåŒå·,å³è¥é”€å®¢æˆ·ç¼–ç .
	2.å³è¾¹å‡ºæ¥çš„æ˜¯å¤šè¡Œå·ç ,ä¸è¥é”€å®¢æˆ·å¹¶ä¸ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch3.exposed = True

def batch4(*k, **kw):
	'''æ ¹æ®å·ç æå•†å“åŒ…ä¼˜æƒ å•†å“'''

	sql = ''' select a.serv_id, a.acc_nbr
	  into temp tab_4m_all
	  from %s a
	 where acc_nbr in (%s);
	select a.*, b.offer_name comp_name, b.offer_comp_id, c.offer_name from tab_4m_all a left join 
	(select serv_id, pg_concat(t3.offer_name||',') offer_name, pg_concat(a.offer_comp_id||',') offer_comp_id from ds_prd_offer_comp_detail a
	left join dim_crm_product_offer t3 on a.offer_comp_id=t3.offer_id --and t3.base_flag=1
	-- and t3.offer_kind='C'
	where serv_id in (select serv_id from tab_4m_all) 
	--and t3.state='00A'
	and t3.offer_kind not in ('0') group by 1)
	b on a.serv_id=b.serv_id
	left join (select serv_id, pg_concat(t3.offer_name||',') offer_name from ds_prd_offer_comp_detail a
	left join dim_crm_product_offer t3 on a.prod_offer_id=t3.offer_id
	-- and t3.offer_kind='C'
	where serv_id in (select serv_id from tab_4m_all) 
	--and t3.state='00A' 
	and t3.offer_kind not in ('0') group by 1)
	c on a.serv_id=c.serv_id

	;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch4', **kw))
	kw_n = my_tools.query_dict(**kw)
	#sql = '''select acc_nbr from %s a where acc_nbr in (%s); ''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name += ymd
	sql = sql % (tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯åˆåŒå·,å³è¥é”€å®¢æˆ·ç¼–ç .
	2.å³è¾¹å‡ºæ¥çš„æ˜¯å¤šè¡Œå·ç ,ä¸è¥é”€å®¢æˆ·å¹¶ä¸ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch4.exposed = True

def batch4_base(*k, **kw):
	'''æåŸºç¡€å•†å“åŒ…'''

	sql = ''' --å…³è”ç›®å½•ç»´è¡¨, å–base_flag=1
	drop table if exists tab_4m_all;
	select a.serv_id, a.acc_nbr
	  into temp tab_4m_all
	  from %s a
	 where acc_nbr in (%s);
	select a.*, pg_concat( distinct c.offer_name||',') comp_name
	--,pg_concat(c.offer_name||',') c_name
	,pg_concat(distinct d.offer_comp_type_desc4||',') å››çº§å¥—é¤
	from tab_4m_all a
	left join ds_prd_offer_comp_detail b on a.serv_id=b.serv_id and b.prod_offer_inst_state='00A' 
	left join dim_crm_product_offer c on b.offer_comp_id=c.offer_id
	--and chh.base_flag=1
	-- and t3.offer_kind='C'
	--and t3.offer_kind not in ('0')
	left join DIM_WD_OFFER_NEW_DIR_SECOND d on b.offer_comp_id=d.offer_comp_type_id6
	where d.base_flag=1
	--å…³è”å¥—é¤ç›®å½•ç»´è¡¨
	group by a.serv_id, a.acc_nbr
	;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch4_base', **kw))
	kw_n = my_tools.query_dict(**kw)
	#sql = '''select acc_nbr from %s a where acc_nbr in (%s); ''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name += ymd
	sql = sql % (tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯åˆåŒå·,å³è¥é”€å®¢æˆ·ç¼–ç .
	2.å³è¾¹å‡ºæ¥çš„æ˜¯å¤šè¡Œå·ç ,ä¸è¥é”€å®¢æˆ·å¹¶ä¸ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch4_base.exposed = True

def batch5(*k, **kw):
	'''æ ¹æ®å·ç ææŸæœˆä¼˜æƒ åè´¹ç”¨'''

	sql = ''' select a.acc_nbr,sum(b.amount) amount 
	from DS_CHN_PRD_SERV_AREA_FEEMONTH a
	left join DS_ACT_ACCT_ITEM_FEEMONTH b on a.serv_id=b.serv_id
	 where a.acc_nbr in (%s)
	 group by 1;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch5', *k, **kw))
	kw_n = my_tools.query_dict(**kw)
	#tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	#ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	#tbl_name += ymd
	#sql = sql % (tbl_name, '%s')
	sql = sql.replace('FEEMONTH', cherrypy.session.get('feemonth',''))
	sql = sql.replace('AREA', cherrypy.session.get('fengongshi',''))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯ç”µè¯å·ç ,
	2.å³è¾¹å‡ºæ¥çš„æ˜¯è´¹ç”¨, ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch5.exposed = True

def batch5_con(*k, **kw):
	'''æ ¹æ®å·ç ææŸæœˆåˆåŒå·ä¼˜æƒ åè´¹ç”¨'''

	sql = ''' select a.acc_nbr, a.mkt_cust_code,count(distinct b.acc_nbr), sum(c.amount) amount 
	from ( select acc_nbr, mkt_cust_code from DS_CHN_PRD_SERV_AREA_FEEMONTH a where acc_nbr in (%s) ) a
	left join ds_chn_prd_serv_AREA_FEEMONTH b on a.mkt_cust_code=b.mkt_cust_code
	left join DS_ACT_ACCT_ITEM_FEEMONTH c on b.serv_id=c.serv_id
	 group by a.acc_nbr, a.mkt_cust_code;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch5_con', *k, **kw))
	kw_n = my_tools.query_dict(**kw)
	#tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	#ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	#tbl_name += ymd
	#sql = sql % (tbl_name, '%s')
	sql = sql.replace('FEEMONTH', cherrypy.session.get('feemonth',''))
	sql = sql.replace('AREA', cherrypy.session.get('fengongshi',''))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯ç”µè¯å·ç ,
	2.å³è¾¹å‡ºæ¥çš„æ˜¯è´¹ç”¨, ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch5_con.exposed = True

def batch6(*k, **kw):
	'''æ ¹æ®åˆåŒå·ææŸæœˆä¼˜æƒ åè´¹ç”¨'''

	sql = ''' select a.mkt_cust_code,sum(b.amount) amount 
	from DS_CHN_PRD_SERV_AREA_FEEMONTH a
	left join DS_ACT_ACCT_ITEM_FEEMONTH b on a.serv_id=b.serv_id
	 where a.mkt_cust_code in (%s)
	 group by 1;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch6', *k, **kw))
	kw_n = my_tools.query_dict(**kw)
	#tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	#ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	#tbl_name += ymd
	#sql = sql % (tbl_name, '%s')
	sql = sql.replace('FEEMONTH', cherrypy.session.get('feemonth',''))
	sql = sql.replace('AREA', cherrypy.session.get('fengongshi',''))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(lambda x: x.strip(), kw_n['acc_nbr'].splitlines())
	acc_nbr = map(lambda x:repr(x), acc_nbr)
	#print ','.join(acc_nbr)
	#print map(len, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.mkt_cust_code and -1 or recs.mkt_cust_code.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.mkt_cust_code))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯ç”µè¯å·ç ,
	2.å³è¾¹å‡ºæ¥çš„æ˜¯è´¹ç”¨, ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch6.exposed = True

def batch4_c(*k, **kw):
	'''æCç½‘å·ç ä¸»ä¼˜æƒ å•†å“'''

	sql = ''' select a.serv_id, a.acc_nbr
	  into temp tab_4m_all
	  from %s a
	 where acc_nbr in (%s);
	select a.*, b.offer_name comp_name,c.offer_name from tab_4m_all a left join 
	(select serv_id, pg_concat(t3.offer_name||'|') offer_name from ds_prd_offer_comp_detail a
	left join dim_crm_product_offer t3 on a.offer_comp_id=t3.offer_id
	-- and t3.offer_kind='C'
	where serv_id in (select serv_id from tab_4m_all) 
	and t3.state='00A' and t3.offer_kind not in ('0') group by 1)
	b on a.serv_id=b.serv_id
	left join (select serv_id, pg_concat(t3.offer_name||'|') offer_name from ds_prd_offer_comp_detail a
	left join dim_crm_product_offer t3 on a.prod_offer_id=t3.offer_id
	-- and t3.offer_kind='C'
	where serv_id in (select serv_id from tab_4m_all) 
	and t3.state='00A' and t3.offer_kind not in ('0')
	and t3.offer_name not in (%s) group by 1)
	c on a.serv_id=c.serv_id

	;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch4_c', **kw))
	kw_n = my_tools.query_dict(**kw)
	#sql = '''select acc_nbr from %s a where acc_nbr in (%s); ''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name += ymd
	sql = sql % (tbl_name, '%s', '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	c_n_file = os.path.join(os.path.dirname(__file__),'c_not.txt')
	c_not = open(c_n_file).read().replace('|',' ').split()
	c_not = list(set(c_not))
	c_not = ','.join(map(repr, c_not))
	sql = sql % ('%s', c_not)
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(recs.acc_nbr))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯åˆåŒå·,å³è¥é”€å®¢æˆ·ç¼–ç .
	2.å³è¾¹å‡ºæ¥çš„æ˜¯å¤šè¡Œå·ç ,ä¸è¥é”€å®¢æˆ·å¹¶ä¸ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch4_c.exposed = True

def batch7(*k, **kw):
	'''æ ¹æ®å·ç ææŸæœˆè¯å•å¼ æ•°åŠè´¹ç”¨'''

	sql = ''' select calling_nbr acc_nbr, count(*) count
	from DS_EVT_CALL_AREA_AREA7_FEEMONTH
	where calling_nbr in (%s)
	 group by 1;
	'''
	t1 = time.time()
	yield ''.join(header(url='batch7', *k, **kw))
	kw_n = my_tools.query_dict(**kw)
	#tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	#ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	#tbl_name += ymd
	#sql = sql % (tbl_name, '%s')
	sql = sql.replace('FEEMONTH', cherrypy.session.get('feemonth',''))
	sql = sql.replace('AREA7', cherrypy.session.get('fengongshi',''))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = kw_n['acc_nbr'].splitlines()
	acc_nbr = acc_nbr_query = map(lambda x: x.strip(), kw_n['acc_nbr'].splitlines())
	acc_nbr = map(lambda x:repr(x), acc_nbr)
	#print ','.join(acc_nbr)
	#print map(len, acc_nbr)
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		#kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % ','.join(acc_nbr)
		recs = dbapi.Table(_sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = [] #'acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = ''.split() #'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.å·¦è¾¹è¾“å…¥çš„æ˜¯ç”µè¯å·ç ,
	2.å³è¾¹å‡ºæ¥çš„æ˜¯è´¹ç”¨, ä¸€ä¸€å¯¹åº”.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch7.exposed = True

def batch8(*k, **kw):
	'''æ ¹æ®åˆåŒå·æŸ¥èµ„æ–™'''

	t1 = time.time()
	yield ''.join(header(url='batch8', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select %s from 
	(select a.*, b.mkt_channel_name, b.mkt_grid_name
	,db.com_channel_name, db.com_grid_name
	from DS_CHN_PRD_CUST_{AREA}_{yyyymmdd} a
	left join dim_zone_area b on a.mkt_grid_id=b.mkt_grid_id
	left join dim_zone_comm db on a.deputy_com_grid_id=db.com_grid_id
	where mkt_cust_code in (%s) 
	) a
	left join ds_chn_prd_serv_{AREA}_{yyyymmdd} b on a.mkt_cust_code=b.mkt_cust_code and b.product_id=102030001
	left join ds_chn_prd_serv_{AREA}_{yyyymmdd} c on a.mkt_cust_code=c.mkt_cust_code and c.product_id=208511177
	;''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('%Y%m%d')
	tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	#sql = sql % ('%s', tbl_name, tbl_cust, tbl_cust_code, '%s')
	sql = sql.replace('{yyyymmdd}', ymd)
	sql = sql.replace('{AREA}', cherrypy.session.get('fengongshi','33'))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	#acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = acc_nbr_query = map(lambda x: x.strip(), kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['a.mkt_cust_code']+kw_n['dis_cols'])
		sql = sql % (kw_n['dis_cols'], ','.join(acc_nbr))
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.mkt_cust_code and -1 or recs.mkt_cust_code.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = 'a.mkt_cust_code  a.mkt_cust_name  user_ad_arrive_num  b.acc_nbr adsl  c.acc_nbr itv  mkt_channel_name  mkt_grid_name  com_channel_name  com_grid_name'.split('  ')
	cols_name = 'è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·åç§° ADSåˆ°è¾¾ç”¨æˆ·æ•° ADSL iTV è¥é”€å®¢æˆ·è¥ç»´éƒ¨ è¥é”€å®¢æˆ·ç½‘æ ¼ ä»£è¡¨å·ç ç»´æŠ¤è¥ç»´éƒ¨ ä»£è¡¨å·ç ç»´æŠ¤ç½‘æ ¼'.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch8.exposed = True

def batch_cust(*k, **kw):
	'''æåŒäº§æƒå®¢æˆ·è®¾å¤‡å·ç '''

	t1 = time.time()
	yield ''.join(header(url='batch_cust', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''--æ ¹æ®è¾“å…¥å·ç æå…¶åŒäº§æƒå®¢æˆ·ä¸‹ä¸‹å®½å¸¦,æ‰‹æœºå·ç 
	select a.*,b.acc_nbr adsl, c.acc_nbr cdma from 
	(select acc_nbr,cust_id from  DS_CHN_PRD_SERV_COM_{AREA}_{yyyymmdd} where acc_nbr in (%s)
	) a
	left join ds_chn_prd_serv_com_{AREA}_{yyyymmdd} b on a.cust_id=b.cust_id and b.product_id=102030001  --adsl
	left join ds_chn_prd_serv_com_{AREA}_{yyyymmdd} c on a.cust_id=c.cust_id and c.product_id=208511296  --cdma
	;''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('%Y%m%d')
	tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	#sql = sql % ('%s', tbl_name, tbl_cust, tbl_cust_code, '%s')
	sql = sql.replace('{yyyymmdd}', ymd)
	sql = sql.replace('{AREA}', cherrypy.session.get('fengongshi','33'))
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	#acc_nbr = acc_nbr_query = map(lambda x: x.strip(), kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr): # and kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['a.mkt_cust_code']+kw_n['dis_cols'])
		#--sql = sql % (kw_n['dis_cols'], ','.join(acc_nbr))
		sql = sql % (','.join(acc_nbr),)
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = 'a.mkt_cust_code  a.mkt_cust_name  user_ad_arrive_num  b.acc_nbr adsl  c.acc_nbr itv  mkt_channel_name  mkt_grid_name  com_channel_name  com_grid_name'.split('  ')
	cols_name = 'è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·åç§° ADSåˆ°è¾¾ç”¨æˆ·æ•° ADSL iTV è¥é”€å®¢æˆ·è¥ç»´éƒ¨ è¥é”€å®¢æˆ·ç½‘æ ¼ ä»£è¡¨å·ç ç»´æŠ¤è¥ç»´éƒ¨ ä»£è¡¨å·ç ç»´æŠ¤ç½‘æ ¼'.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch_cust.exposed = True

def batch_uim(*k, **kw):
	'''æ ¹æ®uimå¡å·æŸ¥å·ç '''

	t1 = time.time()
	yield ''.join(header(url='batch_uim', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select col1,acc_nbr from DM_PRD_PD_DYNAMIC where col1 in (%s);''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	#sql = sql % ('%s', tbl_name, tbl_cust, tbl_cust_code, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(lambda x:x, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and 1: #kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % (','.join(acc_nbr))
		#print sql
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		#print len(recs)
		dis_serial = map(lambda x: x not in recs.col1 and -1 or recs.col1.index(x), acc_nbr_query)
		#print dis_serial
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = []
	cols_name = ''.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch_uim.exposed = True

def batch_byte(*k, **kw):
	'''æ‰‹æœºæµé‡æŸ¥è¯¢'''

	t1 = time.time()
	yield ''.join(header(url='batch_byte', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select billing_nbr, count(*) count, sum(byte_in+byte_out)/(1024*1024) byte from %s where billing_nbr in (%s) and event_type_id in 
	('60645', '60646', '60640', '60641', '60642', '60643', '60644', '60647', '60648', '60650', '60651', '60649', '60652', '60653', '60654', '60655', '60656', '60657',
	'90175', '90176', '90170', '90171', '90172', '90173', '90174', '90177', '90178', '90180', '90181', '90179', '90182', '90183', '90184', '90185', '90186', '90187') group by 1;''' 
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name = 'DS_EVT_PS_AREA'
	fee_month = cherrypy.session.get('feemonth','')
	fengs_id = cherrypy.session.get('fengongshi','33')
	#print ymd, fee_month
	if fee_month and not ymd[1:].startswith(fee_month): #ä¸æ˜¯æŸ¥è¯¢å½“å‰æœˆ
		tbl_name += '_'
		tbl_name += fengs_id
		tbl_name += '_'
		tbl_name += fee_month
	#tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	sql = sql % ( tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(lambda x:x, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and 1: #kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % (','.join(acc_nbr))
		#print sql
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		#print len(recs)
		dis_serial = map(lambda x: x not in recs.billing_nbr and -1 or recs.billing_nbr.index(x), acc_nbr_query)
		#print dis_serial
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = []
	cols_name = ''.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch_byte.exposed = True

def batch_esn(*k, **kw):
	'''æ‰‹æœºå‹å·å†å²æŸ¥è¯¢'''

	t1 = time.time()
	yield ''.join(header(url='batch_esn', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''select * from ds_evt_terminal_info_all_ry where acc_nbr in (%s)order by acc_nbr, register_time desc; '''
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('_%Y%m%d')
	tbl_name = 'DS_EVT_PS_AREA'
	fee_month = cherrypy.session.get('feemonth','')
	fengs_id = cherrypy.session.get('fengongshi','33')
	#print ymd, fee_month
	if fee_month and not ymd[1:].startswith(fee_month): #ä¸æ˜¯æŸ¥è¯¢å½“å‰æœˆ
		tbl_name += '_'
		tbl_name += fengs_id
		tbl_name += '_'
		tbl_name += fee_month
	#tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	#sql = sql % ( tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(lambda x:x, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and 1: #kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % (','.join(acc_nbr))
		#print sql
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		#print len(recs)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		#print dis_serial
		#kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: '\t'.join(map(str,x._data)), recs)))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = []
	cols_name = ''.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch_esn.exposed = True

def batch_esn_xxx(*k, **kw):
	'''æ‰‹æœºæŸæœˆå‹å·æŸ¥è¯¢'''

	t1 = time.time()
	yield ''.join(header(url='batch_esn_xxx', **kw))
	kw_n = my_tools.query_dict(**kw)
	sql = '''--æ³¨æ„é€‰æ‹©æœˆä»½,é€‰å½“å‰æœˆä»½å¯ä»¥æŸ¥æœ€è¿‘çš„ä¸²å·ä¿¡æ¯.
	select b.acc_nbr,b.esn, b.factory, b.type, b.register_time, system
	from (select acc_nbr,max(register_time) last_time from ds_evt_terminal_info_all_ry where acc_nbr in (%s) and register_time<'FEEMONTH' group by 1 order by acc_nbr) a
	left join ds_evt_terminal_info_all_ry b on a.acc_nbr=b.acc_nbr and a.last_time=b.register_time
	--left join ds_chn_prd_serv_{area}_{yyyymmdd} c on b.acc_nbr=c.acc_nbr 
	left join (select * from dim_smart_phone_type_ry union select 'HW-HUAWEI C8600', 'Android 2.2') ry on b.type=ry.phone_type
	--åä¸ºC8600åœ¨é…ç½®è¡¨ä¸­ä¸æ­£ç¡®,æ‰‹å·¥åŠ ä¸Š
	;'''
	tbl_name = 'DS_CHN_PRD_SERV_'+cherrypy.session.get('fengongshi','33')
	tbl_cust = 'DS_CHN_PRD_CUST_'+cherrypy.session.get('fengongshi','33')
	tbl_cust_code = 'DS_PTY_CUST'
	sql = sql.replace('{area}', cherrypy.session.get('fengongshi','33'))
	ymd = (datetime.datetime.now()+datetime.timedelta(days=-2)).strftime('%Y%m%d')
	sql = sql.replace('{yyyymmdd}', ymd)
	tbl_name = 'DS_EVT_PS_AREA'
	fee_month = cherrypy.session.get('feemonth','')
	fengs_id = cherrypy.session.get('fengongshi','33')
	#print ymd, fee_month
	if fee_month and not ymd.startswith(fee_month): #ä¸æ˜¯æŸ¥è¯¢å½“å‰æœˆ
		sql = sql.replace('LAST_DAY', fee_month)
		tbl_name += '_'
		tbl_name += fengs_id
		tbl_name += '_'
		tbl_name += fee_month
	else:
		sql = sql.replace('LAST_DAY', ymd)
	# è¦å–æˆªæ­¢feemonthæœˆä»½åº•çš„ä¸²ç ,æ—¶é—´åº”ä¸ºå°äºå…¶æ¬¡æœˆçš„1æ—¥
	if fee_month[-2:] == '12':
		fee_month = str(int(fee_month)+89)
	else:
		fee_month = str(int(fee_month)+1)
	fee_month = fee_month[:4]+'-'+fee_month[4:]+'-01'
	sql = sql.replace('FEEMONTH', fee_month)
	#tbl_name += ymd
	tbl_cust += ymd
	tbl_cust_code += ymd
	#sql = sql % ( tbl_name, '%s')
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	acc_nbr = acc_nbr_query = map(lambda x:x, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
	if type(kw_n['dis_cols'])<>type([]):
		kw_n['dis_cols'] = [kw_n['dis_cols']]
	if 'rule_type' in kw_n['dis_cols']:
		renling = u"000 éé“¾è·¯è§„åˆ™;001 äº¤æ¥ç®±;002 é…çº¿æ¶;003 åˆ†çº¿ç›’;004 CRMæ¯å±€;005 GISå±€ç«™;006 å°åŒºç¼–ç ;007 é“¾è·¯ç”¨æˆ·å·æ®µè§„åˆ™;008 CRMå±€ç«™;009 å—ç†å·¥å·;010 ç»¼åˆé…çº¿ç®±"
		str_tmp = ' '.join([" when rule_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('rule_type')] = "case %s end" % str_tmp 
	if 'user_grp_type' in kw_n['dis_cols']:
		renling = u"10 æ”¿ä¼å®¢æˆ·;20 å®¶åº­å®¢æˆ·;30 ä¸ªäººå®¢æˆ·;-99 æˆ˜ç•¥å®¢æˆ·ç±»åˆ«ä¸è¯¦"
		str_tmp = ' '.join([" when user_grp_type='%s' then '%s'" % tuple(i.split()) for i in renling.split(';')])
		kw_n['dis_cols'][kw_n['dis_cols'].index('user_grp_type')] = "case %s end" % str_tmp 
	if len(acc_nbr) and 1: #kw_n['dis_cols']<>['']:
		kw_n['dis_cols'] = ','.join(['acc_nbr']+kw_n['dis_cols'])
		sql = sql % (','.join(acc_nbr))
		#print sql
		recs = dbapi.Table(_table=tbl_name, _sqlment = sql, _sqlment_values=[], _values_1=False)
		#print len(recs)
		dis_serial = map(lambda x: x not in recs.acc_nbr and -1 or recs.acc_nbr.index(x), acc_nbr_query)
		#print dis_serial
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or ' ',dis_serial))).decode('utf-8')
		#kw_n['right'] = cgi.escape('\n'.join(map(lambda x: '\t'.join(map(str,x._data)), recs)))
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">\n%(acc_nbr)s</textarea></td>''' % kw_n
	dis_cols = []
	cols_name = ''.split()
	td2 = SELECT(OPTION(cols_name,value=dis_cols,selected=kw.get('dis_cols','')),name="dis_cols", size=len(dis_cols), multiple=[True], style="display:block")
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s%s</td>' % (td2,INPUT(type="submit", value="æå–"))
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td>''' % kw_n
	if kw_n['right'].strip():
		yield '''<script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>'''
	query_notice = '''æŸ¥è¯¢è¯´æ˜:
	1.è¾“å…¥å·ç æ ¼å¼é—®é¢˜, å¦‚æ˜¯8ä½å›ºå®šç”µè¯æˆ–æ— å·å®½å¸¦,åˆ™è‡ªåŠ¨åŠ "023-", è‹¥æ˜¯"2370708080"è¿™ç§å®½å¸¦(åœ¨ç”µå­è¡¨æ ¼ä¸­å‰ç½®0è¢«çœæ‰,åˆ™è‡ªåŠ¨åŠ "023-0",ä»¥ç¬¦åˆè¥ç»´ç³»ç»Ÿçš„å·ç è§„åˆ™.
	2.å¯ä»¥é€‰æ‹©å¤šä¸ªå­—æ®µ,ç”¨é¼ æ ‡æ‹–åŠ¨é€‰æ‹©,æˆ–è€…CTRL+é¼ æ ‡ç‚¹å‡»å•ä¸ªé€‰æ‹©,æˆ–è€…SHIFT+é¼ æ ‡é€‰æ‹©è¿ç»­å¤šä¸ªå­—æ®µ.
	3.è¾“å…¥åŒºåŸŸçš„å·ç å¿…é¡»æ¯è¡Œä¸€ä¸ª.ç»“æœåŒºåŸŸä¸­çš„é¡ºåºä¸è¾“å…¥åŒºåŸŸä¸­çš„ä¸€è‡´,è‹¥æŸå·ç æ²¡æœ‰ç»“æœç»“æœ,åˆ™æ˜¾ç¤ºä¸ºç©ºè¡Œ.æŸ¥è¯¢å®Œæˆå,å³ä¾§åŒºåŸŸçš„å­—æ®µæ˜¯ä»¥TABåˆ†éš”,å¹¶å·²ç»è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´è¡¨(ç›¸å½“äºå…¨é€‰å¹¶æŒ‰äº†CTRL+C), æ­¤æ—¶ç›´æ¥åœ¨ç”µå­è¡¨æ ¼ä¸­ç²˜è´´,å³å¯ä¸ºç”µå­è¡¨æ ¼è¿½åŠ å­—æ®µ.
	4.æŸ¥è¯¢é€Ÿåº¦:å•ä¸ªå·ç åœ¨5ç§’å·¦å³,å› é‡åº†æœªå¯¹postgresqlè¿›è¡Œé€‚å½“çš„ç´¢å¼•,æœ¬æ¥åº”è¯¥æ˜¯æ¯«ç§’çº§ï¼›å¯¹å¤šä¸ªå·ç ,ç»æµ‹è¯•,åœ¨ä¸€æ¬¡æŸ¥è¯¢3600ä¸ªå·ç æ—¶,è´¹æ—¶59ç§’.ä¸å»ºè®®ä¸€æ¬¡æŸ¥è¯¢ä¸Šä¸‡ä¸ªå·ç .
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
	yield '%s' % TR(TD(query_notice, colspan=3))
	yield '</table>'
	yield 'æŸ¥è¯¢è´¹æ—¶:%s' % (time.time()-t1)
	yield ''.join(footer())
batch_esn_xxx.exposed = True

def default(*k, **kw):
	'''é»˜è®¤å¤„ç†æ–¹æ³•'''

	if len(k) >= 1 and k[0].decode('utf-8') in __all__:
		yield ''.join(dis_sub(*k, **kw))
	else:
		yield 'è·¯å¾„ä¸å­˜åœ¨!'
		yield '%s' % str(k)
		yield '%s' % chardet.detect(k[0]) #.decode('gb2312')
default.exposed = True

if __name__ == '__main__':
	'''ä½¿æœ¬ç›®å½•å¯ä»¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„cherrypyåº”ç”¨è¿›è¡Œè¿è¡Œ
	éœ€è¦æ³¨æ„çš„æ˜¯,è¦åšåˆ°æ­¤ç‚¹,æ¯”å¦‚è®ºå›ä¸­çš„äº¤äº’url,å…¨éƒ¨è¦ä½¿ç”¨ç›¸å¯¹url'''
	conf = os.path.join(os.path.dirname(__file__),  '__init__.conf')
	Root = __import__(__file__[:-3])
	cherrypy.quickstart(Root, config=conf)

# $Log: __init__.py,v $
# Revision 1.0  2011-10-08 22:54:04+08  administrator
# Initial revision
#
@


1.3
log
@Ôö¼ÓÁËÅúÁ¿²é·ÑÓÃ,ÅúÁ¿²éÓÅ»İºÍÉÌÆ·°ü,ÅúÁ¿²éCÍøµÄÖ÷ÓÅ»İµÄ¹¦ÄÜ.
@
text
@d6 1
a6 1
__all__ = ['batch1', 'batch21', 'batch22', 'batch3', 'batch4', 'batch5', 'batch4_c']
d27 5
d74 5
a78 1
	sql = '''select %s from %s a left join DIM_ZONE_area b on a.mkt_grid_id=b.mkt_grid_id left join dim_zone_comm c on a.com_grid_id=c.com_grid_id left join %s d on a.mkt_cust_code=d.mkt_cust_code left join dim_crm_product product on a.product_id=product.product_id where acc_nbr in (%s);''' 
d81 1
d83 12
a94 3
	tbl_name += ymd
	tbl_cust += ymd
	sql = sql % ('%s', tbl_name, tbl_cust, '%s')
d104 4
d115 2
a116 2
	dis_cols = ['acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr", "a.state", 'a.serv_state', 'a.serv_num', 'a.completed_time', 'billing_mode_id']
	cols_name = 'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç  ç”¨æˆ·çŠ¶æ€ è®¾å¤‡çŠ¶æ€ åˆ°è¾¾æ ‡å¿— ç«£å·¥æ—¶é—´ è®¡è´¹æ¨¡å¼'.split()
d127 2
a128 1
	5.è‹¥å¯¹æŸ¥è¯¢å­—æ®µæœ‰å¢åŠ éœ€æ±‚,æˆ–å¯¹æ­¤é¡µé¢æœ‰å…¶ä»–å»ºè®®,æ¬¢è¿é€šè¿‡é‚®ç®±æˆ–ç”µè¯æå‡º.ç”µè¯:707019430, é‚®ç®±:yaoguangming@@cq.chinatelecom.com.cn'''.replace('\n', '<br />')
d259 3
a261 3
	select a.*, b.offer_name comp_name,c.offer_name from tab_4m_all a left join 
	(select serv_id, pg_concat(t3.offer_name||',') offer_name from ds_prd_offer_comp_detail a
	left join dim_crm_product_offer t3 on a.offer_comp_id=t3.offer_id
d264 2
a265 1
	and t3.state='00A' and t3.offer_kind not in ('0') group by 1)
d271 2
a272 1
	and t3.state='00A' and t3.offer_kind not in ('0') group by 1)
d315 62
d378 1
a378 1
	'''æ ¹æ®å·ç æŸæœˆä¼˜æƒ åè´¹ç”¨'''
d425 98
d590 457
d1050 1
a1050 1
	if len(k) >= 1 and k[0].decode('utf-8') in sub_list:
@


1.2
log
@1.Ôö¼ÓÁË°´ºÏÍ¬ºÅÌáÉè±¸ºÅÂëµÄÅúÁ¿²éÑ¯
2.²Ëµ¥ÏÔÊ¾,¶Ôµ±Ç°Ñ¡ÖĞ²Ëµ¥²»ÏÔÊ¾Á´½Ó,ÒÔ±íÃ÷µ±Ç°´¦ÓÚÄÄ¸ö²Ëµ¥
3.½á¹ûÇøÓò×Ô¶¯¸´ÖÆµ½¼ôÌù°å¹¦ÄÜ,ÔÚ½á¹ûÎª¿Õ(±ÈÈçÊ×´Î½øÈë,»òÖ´ĞĞ½á¹ûÎª¿ÕÊ±),Ôò²»ÔËĞĞjs½Å±¾,ÒÔ±£ÁôÔ­¼ôÌù°åµÄÄÚÈİ.
@
text
@d3 1
a3 1
import sqlite3, os, chardet, MySQL, cherrypy, cgi, sys, xlrd, time, datetime, traceback, dbapi, config, my_tools
d6 1
a6 1
__all__ = ['batch1', 'batch21', 'batch22', 'batch3']
d14 6
d25 5
d67 1
a67 1
	yield ''.join(header(url='batch1'))
d92 2
a93 2
	dis_cols = ['acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.resid_flag', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr", "a.state", 'a.serv_state', 'a.serv_num']
	cols_name = 'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ æ”¿ä¼å±æ€§ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç  ç”¨æˆ·çŠ¶æ€ è®¾å¤‡çŠ¶æ€ åˆ°è¾¾æ ‡å¿—'.split()
d192 1
a192 1
	yield ''.join(header(url='batch3'))
d227 176
@


1.1
log
@<>
@
text
@d6 1
a6 1
__all__ = ['batch1', 'batch21', 'batch22']
d8 1
a8 1
def header(forum_url=".",**kw):
d21 3
a23 1
		yield ' | <a href="%s">%s</a>' % (col, getattr(globals()[col],'__doc__',col))
d56 1
a56 1
	yield ''.join(header())
d81 2
a82 2
	dis_cols = ['acc_nbr', 'user_name', 'prod_addr', 'mkt_channel_name', 'mkt_grid_name', 'com_channel_name', 'com_grid_name', 'rule_type', 'jjx_code', 'sub_exch_id', 'product_name', 'down_velocity', 'a.mkt_cust_code', "cust_grp_type", "contact_tel", "deputy_acc_nbr"]
	cols_name = 'ç”¨æˆ·ç”µè¯å·ç  ç”¨æˆ·åç§° ç”¨æˆ·åœ°å€ è¥é”€çº¿_è¥ç»´éƒ¨åç§° è¥é”€çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_è¥ç»´éƒ¨åç§° ç»´æŠ¤çº¿_ç½‘æ ¼åç§° ç»´æŠ¤çº¿_é“¾è·¯è®¤é¢†è§„åˆ™åç§° äº¤æ¥ç®±ç¼–ç  æ¯å±€åç§° äº§å“å››çº§åç§° å¸¦å®½é€Ÿç‡_ä¸‹è¡Œ è¥é”€å®¢æˆ·ç¼–ç  å®¢æˆ·æˆ˜ç•¥åˆ†ç¾¤ å®¢æˆ·_è”ç³»ç”µè¯ å®¢æˆ·_ä»£è¡¨å·ç '.split()
d85 3
a87 1
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td><script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
d103 1
a103 1
	return ''.join(batch2(rule1=1, rule2=2, rule3=90, group_type_id=1000, *k, **kw))
d109 1
a109 1
	return ''.join(batch2(rule1=1, rule2=1518, rule3=1519, group_type_id=2003, *k, **kw))
d142 1
a142 2
	yield '<table border=2 width=100%%><tr><td colspan=3>sqlè¯­å¥æ¨¡æ¿:%s</td>' % sql
	print acc_nbr_query, 'acc_nbr_query'
d163 3
a165 1
	yield '''<td with="60%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td><script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
d176 40
@


1.0
log
@Initial revision
@
text
@d3 1
a3 1
import sqlite3, os, chardet, MySQL, cherrypy, cgi, sys, xlrd, time, datetime, traceback, dbapi
d8 1
a8 8
class query_dict(dict):
	def __getitem__(self, name):
		try:
			return dict.get(self, name, '').encode('utf-8','ignore')
		except:
			return dict.get(self, name, '')

def header(forum_url="."):
d11 3
d15 4
d29 1
a29 1
def index():
d32 1
a32 1
	yield ''.join(header())
d55 1
a55 2
	kw_n = query_dict()
	kw_n.update(kw)
d78 1
a78 1
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">%(acc_nbr)s</textarea></td>''' % kw_n
d99 1
a99 1
	return ''.join(batch2('1,2', *k, **kw))
d105 1
a105 1
	return ''.join(batch2('1518,1519', *k, **kw))
d107 2
a108 1
def batch2(group_type, *k, **kw):
d112 23
a134 4
	yield ''.join(header())
	kw_n = query_dict()
	kw_n.update(kw)
	sql = '''select a.acc_nbr acc_nbr,aa.acc_nbr acc_nbr_2 from ds_chn_prd_serv_AREA_FEEMONTH a left join dm_prd_crm_service_grp_member b on a.serv_id=b.serv_id and b.member_role_id in (%s) left join dm_prd_crm_service_grp_member bb on b.group_id=bb.group_id and bb.member_role_id in (%s) and bb.member_role_id<>b.member_role_id  left join ds_chn_prd_serv_AREA_FEEMONTH aa on bb.serv_id=aa.serv_id where b.member_role_id<>bb.member_role_id and a.acc_nbr in (%s);''' % (group_type, group_type, '%s')
d139 5
a143 2
	acc_nbr = acc_nbr_query = map(add_pro, kw_n['acc_nbr'].splitlines())
	acc_nbr = map(repr, acc_nbr)
d145 6
a150 1
		sql = sql % ','.join(acc_nbr)
d153 8
a160 5
		print dis_serial
		kw_n['right'] = cgi.escape('\n'.join(map(lambda x: x<>-1 and '\t'.join(map(str,recs[x]._data[1:])) or '',dis_serial))).decode('utf-8')
	yield '''<tr><td width="15%%" align="center"><form method="post" name=form2 >è¾“å…¥åŒºåŸŸ<br /><textarea name="acc_nbr" style="BBfloat:left;BBwidth:100%%;border:solid 3;margin:3;display:inline"" onfocus="document.form2.acc_nbr.select()">%(acc_nbr)s</textarea></td>''' % kw_n
	yield '<td width="15%%" align="center">é€‰æ‹©è¾“å‡ºå­—æ®µ<br />%s</td>' % INPUT(type="submit", value="æå–")
	yield '''<td with="70%%" align="center">ç»“æœåŒºåŸŸ<br /><textarea name=right style="border:solid 3px;BBwidth:45%%;margin:3" readonly onblur="selectAll()">%(right)s</textarea></td><script language="javascript">document.form2.right.select(); document.form2.right.focus();var d = document.form2.right.value; window.clipboardData.setData("text", d);</script>''' % kw_n
@
